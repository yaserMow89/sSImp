Service Accounts
================

- Two types of accounts in k8s: **User** (Used by humans) and **service** (Used by *machines*) Account

## *Service* Account
- Create `k create serviceaccount <name>`
- `k get serviceaccount`
- `k describe serviceaccount <name>`
- Creates the *`token`* Automatically
   - Must be used by the applications while authenticating to the k8s api
   - Token is stored as a secret object
   - How it is created?
      - SA
      - Token
      - Secret
      - Store token inside the secret
      - Link secret to the sa
      - to view the secret `k describe secret <name>`
- Automatically mounting the token as a volume inside the pod which we are intending to use and is hosting a 3rd party application
   - This way the token is already placed inside the pod and can be easily read by application

### Default Service Account
- For each `namespace`
- whenever a **pod** is created the default **SA** and it's token are automatically mounted into that pod as a volume mount
   - If you `describe` the pod
      - You would be able to see a **volume** is automatically created from the *secret* named `default-token`
         - It is the **secret** containing the token for the **default** `serviceAccount`
      - It is ran at `/var/run/secrets/kubernetes.io/serviceaccount` inside the pod
         - `k exec -it <podName> ls /var/run/secrets/kubernetes.io/serviceaccount`
         - You can also `cat` the content of the file to access the actual token
- It is very restricted and has limited functionalities
- You can add a separate service account inside a pod, using the field `.spec.serviceAccountName: <saName>`
- You can also avoid the auto mount for the `default sa` by `.spec.automountServiceAccountToken: false`

## `1.24/1.24` Updates
- No **Expiry date** on the *default* token
- Version *`1.22`* introduced **TokenRequestAPI**
   - Mechanism for provisioning k8s service account tokens with more security and scalability via `API`
   - Tokens generated by **TokenRequestAPI** are:
      1. *Audience Bound*
      2. *Time Bound*
      3. *Object Bound*
- Version `1.24`
   - In the past by creating a **service Account**
      - A secret was also created
      - A token was also created within the *secret*
      - Bound to no *expiry* date
      - If a pod was using that servicAccount this was mounted automatically into that
   - Now no longer a **secret** or **token** is created by creating the `serviceAccount`
      - You must run `k create token <saName>` --> prints the token on the screen
      - This token has an `Expiry` date
   - You can still create **Secrets** in the old way with no `Expiry` date, using this:
      * Make sure you have the **serviceAccount** created first
   ```
   apiVersion: v1
   kind: Secret
   type: kubernetes.io/service-account-token
   metadata:
      name: <name>
      annotations:
         kubernetes.io/service-account.name: <saName>
   ```

- For analyzing the tokens you can go to [jwt](jwt.io), try decoding them, and you should get all the info inside the token

- You can also use `k set serviceaccount deploy/<saName> # Not very sure if this is correct` to set an sa to a deployment
